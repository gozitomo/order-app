{% extends "base.html" %}
{% block content %}
<table>
    <tr>
        <td nowrap class="fs-5">{{ product.name }} </td>
        <td nowrap class="small">（{{ product.season }}）</td>
    </tr>
</table>
<p class="small text-muted">{{ product.description|safe }}</p>

<form id="order-form" method="post" onsubmit="return handleSubmit(event)">
    {% csrf_token %}
    <p><strong>納品希望:</strong>
        <select name="delivery_date">
            {% for date in delivery_dates %}
            <option value="{{ date.value }}">{{ date.label }}</option>
            {% endfor%}
        </select>
    </p>
    <p><strong>配送区分:</strong>           
        <input type="radio" name="cool_flg" value="false">通常便
        <input type="radio" name="cool_flg" value="true" checked>冷蔵便
    </p>
    <div class="table-responsive">
    <table>
        <tr>
             <th class="text-center d-none d-sm-table-cell">等級</th>
             <th class="text-center d-none d-sm-table-cell">階級</th>
             <th class="text-center d-none d-sm-table-cell">ユニット</th>
             <th class="text-center d-none d-sm-table-cell">税込価格</th>
             <th class="text-center d-none d-sm-table-cell">数量</th>
        </tr>
        <tbody id="order-body">
            <tr>
                <td>
                    <select name="grade_0">
                        {% for grade in grades %}
                        <option value="{{ grade }}">{{ grade }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <select name="size_0">
                        {% for size in sizes %}
                        <option value="{{ size }}">{{ size }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <select name="unit_0">
                        {% for unit in units %}
                        <option value="{{ unit }}">{{ unit }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <span class="price_display">-</span>円
                </td>
                <td>
                    <input inputmode="numeric" name="quantity_0" value="" min="0" class="form-control" style="max-width: 50px;">
                </td>
            </tr>
        </tbody>
    </table>
    </div>
    <br>
    <button type="button" class="btn btn-sm btn-primary me-2" style="padding: 2px 8px; font-size: 0.75rem;" onclick="addRow()">+ 行を追加</button>
    <br><br>
    <strong>特記事項</strong>
    <input type=text name="remarks" class="form-control" style="max-width: 450px;">
    <br>
    <button type="submit" id="kari-order" class="btn btn-sm btn-primary me-2" style="padding: 2px 8px; font-size: 0.75rem;">仮注文</button>

</form>

<script>
    const priceData = {{ price_data_json|safe }};
    let rowIndex = 1;

    function updateSelectOptions(select, validOptions, currentValue){
        select.innerHTML = ""; //一旦全削除
        validOptions.forEach(opt => {
            const option = document.createElement("option");
            option.value = opt;
            option.text = opt;
            select.appendChild(option);
        });

        //前の値がまだ有効なら保持
        if (validOptions.includes(currentValue)){
            select.value = currentValue;
        }
    }

    function attachUpdater(row, index) {
        const grade = row.querySelector(`select[name="grade_${index}"]`);
        const size = row.querySelector(`select[name="size_${index}"]`);
        const unit = row.querySelector(`select[name="unit_${index}"]`);
        const price = row.querySelector('.price_display');

        function updateOptions(){
            const selectedGrade = grade.value;
            const selectedSize = size.value;
            const selectedUnit = unit.value;

            const validForGrade = [...new Set(priceData
                .filter(p => p.size === selectedSize && p.unit === selectedUnit)
                .map(p => p.grade))];

            const validForSize = [...new Set(priceData
                .filter(p => p.grade === selectedGrade && p.unit === selectedUnit)
                .map(p => p.size))];

            const validForUnit = [...new Set(priceData
                .filter(p => p.size === selectedSize && p.grade === selectedGrade)
                .map(p => p.unit))];
        
            //各selectの更新
            updateSelectOptions(grade, validForGrade);
            updateSelectOptions(size, validForSize);
            updateSelectOptions(unit, validForUnit);

            const match = priceData.find(opt =>
                opt.grade === grade.value &&
                opt.size === size.value &&
                opt.unit === unit.value
            );
            price.textContent = match ? Number(match.price).toLocaleString() : '-';
        }

        grade.addEventListener("change", updateOptions);
        size.addEventListener("change", updateOptions);
        unit.addEventListener("change", updateOptions);

        updateOptions();
    }

    function addRow() {
        const tbody = document.getElementById('order-body');
        const firstRow = tbody.querySelector('tr');
        const newRow = firstRow.cloneNode(true);

        newRow.querySelectorAll('select, input').forEach(el => {
            if (el.name){
            el.name = el.name.split('_')[0] + `_${rowIndex}`;
            }
            if (el.tagName === 'INPUT') {
                el.value = "";
            }
        });

        tbody.appendChild(newRow);
        attachUpdater(newRow, rowIndex);
        rowIndex++;
    }

    window.addRow = addRow;

    function handleSubmit(event){
        //submit元が明確でない場合、処理を中断
        if (event.submitter && event.submitter.id !== "kari-order") {
            return false;
        }
        else{
        const inputs = document.querySelectorAll('input[name^="quantity_"]');
        let total = 0;
        inputs.forEach(input => {
            const val = parseInt(input.value);
            if (!isNaN(val)){
                total += val;
            }
        });

        if (total === 0){
            alert("数量を1以上にしてください。");
            event.preventDefault(); //フォーム送信をブロック
        }
        const btn = document.getElementById('kari-order');
        btn.disabled = true;
        btn.innerText = "送信中..."

        return true;
    }
    }

    document.addEventListener("DOMContentLoaded", function(){
        // すべての input に対して Enter キーをブロック
        const inputs = document.querySelectorAll('input');
        inputs.forEach(function(input) {
            input.addEventListener('keydown', function(event) {
                if (event.key === "Enter") {
                    if (event.target.type !== "submit" && event.target.tagName !== "TEXTAREA") {
                        event.preventDefault();
                    }
                }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const firstRow = document.getElementById('order-body').querySelector('tr');
        attachUpdater(firstRow, 0);
    });
</script>
{% endblock %}
