{% extends "base.html" %}
{% load humanize %}
{% block title %}ご注文明細{% endblock %}
{% block content %}
{% csrf_token %}
    <h2>ご注文内容の変更</h2>
    <form method="POST" action="{% url 'order_change' order.id%}">
        {% csrf_token %}
        {% if order.status == 'キャンセル' %}
            <p style="color: red;"><strong>この注文はキャンセルされました。</strong></p>
        {% elif order.status == 'キャンセル不可' %}
            <p style="color: red;"><strong>この注文は納品希望日まで10日を切りましたので、キャンセル不可となります。
            <br>Lineまたはお電話にてお問い合わせくださいませ</strong></p>
        {% endif %}
    <p><strong>納品希望日:</strong>
        <select name="delivery_date">
            {% for date in delivery_dates %}
            <option value="{{ date.value }}">{{ date.label }}</option>
            {% endfor%}
        </select>
    <p><strong>注文ID:</strong>{{ order.id }}</p>
    <p><strong>注文日時:</strong>{{ order.created_at|date:"Y-m-d H:i" }}</p>
    <div class="table-responsive">
        <table class="thead-light">
            <tr>
                <th class="d-none d-sm-table-cell">商品名</th>
                <th class="d-none d-sm-table-cell">等級</th>
                <th class="d-none d-sm-table-cell">階級</th>
                <th class="d-none d-sm-table-cell">量目</th>
                <th class="d-none d-sm-table-cell">数量</th>
                <th class="d-none d-sm-table-cell">単価</th>
                <th class="d-none d-sm-table-cell">小計(内税) </th>
            </tr>
            {% for item in order.items.all %}
            <tr>
                <td style="width:20%">{{ item.product.name }}</td>
                <td style="width:10%">{{ item.grade }}</td>
                <td style="width:10%">{{ item.size }}</td>
                <td style="width:10%">{{ item.amount }}</td>
                <td style="text-align:right width:10%">
                    <input type="number" name="quantity_{{ item.id }}" value="{{ item.quantity }}" min="0" class="form-control" style="max-width: 80px;">{{ item.unit }}
                </td>
                <td style="text-align:right width:10%">{{ item.price|intcomma }} 円</td>
                <td style="text-align:right width:10%">{{ item.subtotal|intcomma }} 円</td>
            </tr>
            {% endfor %}

        </table>
    </div>
    <hr>
    <p><strong>合計：</strong>{{ order.total_price|intcomma }}円</p>
    <hr>
    <p><strong>送料：</strong>{{ order.total_shipping_fee|intcomma }}円</p>
    <p><strong>総計：</strong>{{ order.final_total|intcomma }}円</p>

    <!--<p><a href="{% url 'order_invoice_pdf' order.id %}" target="_blank">請求書</a></p>-->
    <div class="text-end mt-3">
        <button type="submit" class="btn btn-primary me-2" style="padding: 2px 8px; font-size: 0.75rem;">
          確定
        </button>
    </form>
    {% if order.status == '仮注文' %}
    <form method="POST" action="{% url 'order_cancel' order.id %}">
        {% csrf_token %}
        <button type="submit" onclick="return confirm('この注文をキャンセルしますか？');" class="btn btn-link btn-sm text-decoration-none">
            この注文をキャンセルする
        </button>
    </form>
    {% elif order.status == 'キャンセル不可' %}
        <span style="color: gray;">(キャンセル不可)</span>
    {% elif order.status == 'キャンセル' %}
        <span style="color: gray;">(キャンセル済みです。)</span>
    {% endif %}
    <p><a href="{% url 'order_history' %}">←　注文履歴に戻る</a></p>
    </div>
{% endblock %}