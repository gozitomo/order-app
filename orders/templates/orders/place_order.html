{% extends "base.html" %}
{% load my_filters %}
{% block title %}注文発注{% endblock %}
{% block content %}
    <style>
        table {
            width: 80%;
            border-collapse: collapse;
            margin-top: 1em;
            font-family: sans-serif;
        }
    
        th, td {
            border: 1px solid #ccc;
            padding:8px 12px;
            text-align: center;
        }
    
        th {
            background-color: #f5f5f5;
        }
    
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    
        input[type="number"] {
            width: 60px;
            text-align: right;
        }
    
        button {
            margin-top: 1em;
            padding: 6px 12px;
            font-size: 1em;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const priceData = {{ price_data_json|safe }};

            {% for product in products %}
            const gradeSelect_{{ product.id }} = document.querySelector('select[name="grade_{{ product.id }}"]');
            const sizeSelect_{{ product.id }} = document.querySelector('select[name="size_{{ product.id }}"]');
            const amountSelect_{{ product.id }} = document.querySelector('select[name="amount_{{ product.id }}"]');
            const priceDisplay_{{ product.id }} = document.getElementById('price_display_{{ product.id }}');
            const unitDisplay_{{ product.id }} = document.getElementById('unit_display_{{ product.id }}');

            function updatePrice{{ product.id }}(){
                const selectedGrade = gradeSelect_{{ product.id }}.value;
                const selectedSize = sizeSelect_{{ product.id }}.value;
                const selectedAmount = amountSelect_{{ product.id }}.value;

                const options = priceData["{{ product.id }}"];
                const match = options.find(opt =>
                    opt.grade === selectedGrade &&
                    opt.size === selectedSize &&
                    opt.amount === selectedAmount
                );

                if (match){
                    priceDisplay_{{ product.id }}.textContent = match.price;
                    unitDisplay_{{ product.id }}.textContent = match.unit;
                }
                else {
                    priceDisplay_{{ product.id }}.textContent = "-";
                    unitDisplay_{{ product.id }}.textContent = "-";
                }
            }
            gradeSelect_{{ product.id }}.addEventListener('change', updatePrice{{ product.id }});
            sizeSelect_{{ product.id }}.addEventListener('change', updatePrice{{ product.id }});
            amountSelect_{{ product.id }}.addEventListener('change', updatePrice{{ product.id }});

            {% endfor %}
        });

        //行追加
        function addRow(productId) {
            const tbody = document.getElementById('product-' + productId);
            const originalRow = document.getElementById('row-' + productId);
            const newRow = originalRow.cloneNode(true); //clone the last rows

            //Reset select inside the new rows
            const selects = newRow.querySelectorAll('select');
            selects.forEach(select => {
                select.selectedIndex = 0;
            });

            //Reset values inside the new rows
            const inputs = newRow.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.value = 0;
            });

            tbody.appendChild(newRow);
        }
    </script>
    <h1>商品を選んで発注</h1>

    <form method="POST">
        {% csrf_token %}
        <table style="width: 100%;">
            <tr>
                <th width="20%">商品名</th>
                <th width="10%">等級</th>
                <th width="10%">階級</th>
                <th width="10%">量目</th>
                <th width="20%">単価</th>
                <th width="20%">納品希望日</th>
                <th width="10%">数量</th>
            </tr>
            {% for product in products %}
            <tbody id="product-{{ product.id }}">
            <tr id="row-{{ product.id }}">
                <td style="text-align:center;">{{ product.name }}</td>
                <td>
                    <select name="grade_{{ product.id }}">
                        {% for grade in grades_data|get_item:product.id %}
                        <option value="{{ grade }}">{{ grade }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <select name="size_{{ product.id }}">
                        {% for size in sizes_data|get_item:product.id %}
                        <option value="{{ size }}">{{ size }}</option>
                        {% endfor %}
                </td>
                <td>
                    <select name="amount_{{ product.id }}">
                        {% for amount in amounts_data|get_item:product.id %}
                        <option value="{{ amount }}">{{ amount }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <span id="price_display_{{ product.id }}">{{ product.kind.options.first.price }}</span>円／
                    <span id="unit_display_{{ product.id }}">{{ product.kind.options.first.unit }}</span>
                </td>
                <td>
                    <select name="delivery_{{ product.id }}">
                        {% for d in product.available_dates.all %}
                        <option value="{{ d.date }}">{{ d.date|date:"Y/m/d" }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td style="text-align:center;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="number" name="quantity_{{ product.id }}" style="text-align:right; width:40px;" min="0" value="0">{{ product.kind.options.first.unit }}
                    </div>
                </td>
            </tr>
            </tbody>
            <!-- Add button -->
            <tr>
                <td colspan="7" style="text-align:center;">
                    <button type="button" onclick="addRow({{ product.id }})">+追加</button>
                </td>
            </tr>

            {% endfor %}
        </table>
        <br>
        <button type="submit">発注する</button>
    </form>

    <p><a href="{% url 'order_history' %}">注文履歴に戻る</a></p>
    <hr>
    <p><strong>※発注後に送料・合計金額が注文履歴に表示されます</strong></p>
{% endblock %}