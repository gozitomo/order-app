{% extends "base.html" %}
{% load my_filters %}
{% block title %}注文発注{% endblock %}
{% block content %}
    <style>
        table {
            width: 80%;
            border-collapse: collapse;
            margin-top: 1em;
            font-family: sans-serif;
        }
    
        th, td {
            border: 1px solid #ccc;
            padding:8px 12px;
            text-align: center;
        }
    
        th {
            background-color: #f5f5f5;
        }
    
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    
        input[type="number"] {
            width: 60px;
            text-align: right;
        }
    
        button {
            margin-top: 1em;
            padding: 6px 12px;
            font-size: 1em;
        }
    </style>
    <script>
        const priceData = {{ price_data_json|safe }};
        let rowCounters = {};

        function attachPriceupdater(row, productId, rowIndex) {
            const gradeSelect = row.querySelector('select[name="grade_' + productId + "_" + rowIndex + '"]');
            const sizeSelect = row.querySelector('select[name="size_' + productId + "_" + rowIndex + '"]');
            const amountSelect = row.querySelector('select[name="amount_' + productId + "_" + rowIndex + '"]');
            //const priceDisplay = row.querySelector('.price_display');
            //const unitDisplay = row.querySelector('.unit_display');

            function updatePrice(){
                const selectedGrade = gradeSelect.value;
                const selectedSize = sizeSelect.value;
                const selectedAmount = amountSelect.value;

                const options = priceData[productId];
                const match = options.find(opt =>
                opt.grade === selectedGrade &&
                opt.size === selectedSize &&
                opt.amount === selectedAmount
                );

                //if (match) {
                //   if (priceDisplay) priceDisplay.textContent = match.price;
                //    if (unitDisplay) unitDisplay.textContent = match.unit;
                //} else {
                //    if (priceDisplay) priceDisplay.textContent = "-";
                //    if (unitDisplay) unitDisplay.textContent = "-";
                //}
            }

            gradeSelect.addEventListener('change', updatePrice);
            sizeSelect.addEventListener('change', updatePrice);
            amountSelect.addEventListener('change', updatePrice);
        }


        
        document.addEventListener('DOMContentLoaded', function(){
            //Set up for all initial rows(indes _0)
            {% for product in products %}
            const row = document.getElementById('row_{{ product.id }}_0');
            //attachPriceupdater(row, {{ product.id }}, 0);
            rowCounters[{{ product.id }}] = 1;
            {% endfor %}
        })


        //行追加


        function addRow(productId) {

            const tbody = document.getElementById('product_' + productId);
            const originalRow = document.getElementById(`row_${productId}_0`);
            const newRow = originalRow.cloneNode(true); //clone the last rows
            const newIndex = rowCounters[productId];

            // Update names and inside
            newRow.id = `row_${productId}_${newIndex}`;

            //Reset select inside the new rows
            newRow.querySelectorAll('select, input').forEach(el => {
                if (el.name){
                    el.name = el.name.replace(`_${productId}_0`, `_${productId}_${newIndex}`);
                }
                if (el.id){
                    el.id = el.id.replace(`_${productId}_0`, `_${productId}_${newIndex}`);
                }
                if (el.tagName === 'INPUT') {
                    el.value = 0;
                }
            });

            const priceEl = newRow.querySelector('.price_display');
            if (priceEl) priceEl.textContent = "-";
            const unitEl = newRow.querySelector('.unit_display');
            if (unitEl) unitEl.textContent = "-";

            tbody.appendChild(newRow);
            //attachPriceupdater(newRow, productId, newIndex);
            rowCounters[productId] += 1;
        }
    </script>
    <h1>商品を選んで発注</h1>

    <form method="POST">
        {% csrf_token %}
        <table style="width: 100%;">
            <tr>
                <th width="20%">商品名</th>
                <th width="10%">等級</th>
                <th width="10%">階級</th>
                <th width="10%">量目</th>
                <th width="20%">単価</th>
                <th width="20%">納品希望日</th>
                <th width="10%">数量</th>
            </tr>
            {% for product in products %}
            <tbody id="product_{{ product.id }}">
            <tr id="row_{{ product.id }}_0">
                <td style="text-align:center;">{{ product.name }}</td>
                <td>
                    <select name="grade_{{ product.id }}_0">
                        {% for grade in grades_data|get_item:product.id %}
                        <option value="{{ grade }}">{{ grade }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <select name="size_{{ product.id }}_0">
                        {% for size in sizes_data|get_item:product.id %}
                        <option value="{{ size }}">{{ size }}</option>
                        {% endfor %}
                </td>
                <td>
                    <select name="amount_{{ product.id }}_0">
                        {% for amount in amounts_data|get_item:product.id %}
                        <option value="{{ amount }}">{{ amount }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <span id="price_display_{{ product.id }}_0" class="price_display">{{ product.kind.options.first.price }}</span>円／
                    <span id="unit_display_{{ product.id }}_0" class="unit_display">{{ product.kind.options.first.unit }}</span>
                </td>
                <td>
                    <select name="delivery_{{ product.id }}_0">
                        {% for d in product.available_dates.all %}
                        <option value="{{ d.date }}">{{ d.date|date:"Y/m/d" }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td style="text-align:center;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="number" name="quantity_{{ product.id }}_0" value="0" min="0" class="quantity" style="text-align:right; width:40px;" min="0" value="0">{{ product.kind.options.first.unit }}
                    </div>
                </td>
            </tr>
            </tbody>
            <!-- Add button -->
            <tr>
                <td colspan="7" style="text-align:center;">
                    <button type="button" onclick="addRow({{ product.id }})">+追加</button>
                </td>
            </tr>

            {% endfor %}
        </table>
        <br>
        <button type="submit">発注する</button>
    </form>

    <p><a href="{% url 'order_history' %}">注文履歴に戻る</a></p>
    <hr>
    <p><strong>※発注後に送料・合計金額が注文履歴に表示されます</strong></p>
{% endblock %}